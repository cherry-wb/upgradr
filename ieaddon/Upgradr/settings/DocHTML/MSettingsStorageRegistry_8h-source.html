<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SettingsStorage: MSettingsStorageRegistry.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a></div>
<h1>MSettingsStorageRegistry.h</h1><div class="fragment"><pre>00001 <span class="comment">//========================================================================================</span>
00002 <span class="comment">//</span>
00003 <span class="comment">// Module:          SettingsStorage</span>
00004 <span class="comment">// Author:          Pascal Hurni</span>
00005 <span class="comment">// Creation Date:   20.12.2003</span>
00006 <span class="comment">//</span>
00007 <span class="comment">// Copyright 2003 Mortimer Systems</span>
00008 <span class="comment">// This software is free. I grant you a non-exclusive license to use it.</span>
00009 <span class="comment">//</span>
00010 <span class="comment">// This work is based on CRegSettings, Copyright (C) 2002 Magomed G. Abdurakhmanov, maq@mail.ru</span>
00011 <span class="comment">//</span>
00012 <span class="comment">// Modifications:</span>
00013 <span class="comment">//</span>
00014 <span class="comment">//  2004-05-11  By Pascal Hurni</span>
00015 <span class="comment">//</span>
00016 <span class="comment">//              Removed Collection related functions and subitem function.</span>
00017 <span class="comment">//              Standard ones relies now in the base class CSettingsStorage.</span>
00018 <span class="comment">//</span>
00019 <span class="comment">//  2004-04-19  By Pascal Hurni</span>
00020 <span class="comment">//</span>
00021 <span class="comment">//              SaveLoadItem() for TCHAR updated to follow spec of CSettingsStorage.</span>
00022 <span class="comment">//</span>
00023 <span class="comment">//========================================================================================</span>
00024 
00025 <span class="preprocessor">#ifndef __MORTIMER_SETTINGSSTORAGEREGISTRY_H__</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#define __MORTIMER_SETTINGSSTORAGEREGISTRY_H__</span>
00027 <span class="preprocessor"></span>
00028 <span class="preprocessor">#include "MSettingsStorage.h"</span>
00029 
00030 <span class="preprocessor">#ifndef MAX_PATH</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#define MAX_PATH 256</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00033 <span class="preprocessor"></span>
00034 <span class="preprocessor">#ifndef DOXYGEN_SHOULD_SKIP_THIS</span>
00035 <span class="preprocessor"></span><span class="keyword">namespace </span>Mortimer
00036 {
00037 <span class="preprocessor">#endif</span>
00038 <span class="preprocessor"></span>
<a name="l00040"></a><a class="code" href="classCSettingsStorageRegistry.html">00040</a> <span class="keyword">class </span><a class="code" href="classCSettingsStorageRegistry.html">CSettingsStorageRegistry</a> : <span class="keyword">public</span> <a class="code" href="classCSettingsStorage.html">CSettingsStorage</a>
00041 {
00042 <span class="keyword">protected</span>:
00043     HKEY m_hKey;
00044     HKEY m_hKeyParent;
00045     TCHAR m_sKey[MAX_PATH];
00046 
00047 <span class="keyword">public</span>:
00048     <a class="code" href="classCSettingsStorageRegistry.html">CSettingsStorageRegistry</a>() : m_hKey(NULL), m_hKeyParent(NULL)
00049     {
00050         m_sKey[0] = 0;
00051     }
00052 
<a name="l00054"></a><a class="code" href="classCSettingsStorageRegistry.html#a1">00054</a>     <a class="code" href="classCSettingsStorageRegistry.html">CSettingsStorageRegistry</a>(HKEY  hKeyParent, LPCTSTR KeyName)
00055     {
00056         SetBaseKeyName(hKeyParent, KeyName);
00057     }
00058 
00059     <a class="code" href="classCSettingsStorage.html">CSettingsStorage</a> *CreateSubStorage(LPCTSTR SubName)
00060     {
00061         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classCSettingsStorageRegistry.html">CSettingsStorageRegistry</a>(m_hKey, SubName);
00062     }
00063 
<a name="l00068"></a><a class="code" href="classCSettingsStorageRegistry.html#a3">00068</a>     <span class="keywordtype">void</span> SetBaseKeyName(HKEY hKeyParent, LPCTSTR KeyName)
00069     {
00070         m_hKeyParent = hKeyParent;
00071         _tcsncpy(m_sKey, KeyName, MAX_PATH);
00072     }
00073 
00074     <span class="keywordtype">bool</span> OnBeforeLoad()
00075     {
00076         <span class="keywordflow">return</span> ERROR_SUCCESS == ::RegOpenKeyEx(m_hKeyParent, m_sKey, 0, KEY_READ, &amp;m_hKey);
00077     }
00078 
00079     <span class="keywordtype">bool</span> OnAfterLoad()
00080     {
00081         DWORD dwResult = ERROR_SUCCESS;
00082         <span class="keywordflow">if</span> (m_hKey) dwResult = ::RegCloseKey(m_hKey);
00083         m_hKey = NULL;
00084         <span class="keywordflow">return</span> ERROR_SUCCESS == dwResult;
00085     }
00086 
00087     <span class="keywordtype">bool</span> OnBeforeSave()
00088     {
00089         <span class="keywordflow">return</span> ERROR_SUCCESS == ::RegCreateKeyEx(m_hKeyParent, m_sKey, NULL, NULL, REG_OPTION_NON_VOLATILE,
00090             KEY_WRITE, NULL, &amp;m_hKey, NULL);
00091     }
00092 
00093     <span class="keywordtype">bool</span> OnAfterSave()
00094     {
00095         DWORD dwResult = ERROR_SUCCESS;
00096         <span class="keywordflow">if</span> (m_hKey) dwResult = ::RegCloseKey(m_hKey);
00097         m_hKey = NULL;
00098         <span class="keywordflow">return</span> ERROR_SUCCESS == dwResult;
00099     }
00100 
00101     <span class="keywordtype">bool</span> ContinueOnError()
00102     {
00103         <span class="comment">// We want the system to read/write the most possible items, even if one fails</span>
00104         <span class="comment">// (There's no serialization issue with the registry)</span>
00105         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00106     }
00107 
00108 <span class="keyword">public</span>:
00109     <span class="comment">//------------------------------------------------------------------------------------</span>
00110     <span class="comment">// Here are the type specific SaveLoad functions</span>
00111 
00112     <span class="comment">// unsigned long (DWORD)</span>
00113     <span class="keyword">inline</span> <span class="keywordtype">bool</span> SaveLoadItem(LPCTSTR szName, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>&amp; Variable, <span class="keywordtype">bool</span> bSave)
00114     {
00115         DWORD dwType = REG_DWORD;
00116         DWORD dwSize = <span class="keyword">sizeof</span>(DWORD);
00117         <span class="keywordflow">if</span>(bSave)
00118             <span class="keywordflow">return</span> ERROR_SUCCESS == ::RegSetValueEx(m_hKey, szName, NULL, dwType, (<span class="keyword">const</span> BYTE*)&amp;Variable, dwSize);
00119         <span class="keywordflow">else</span>
00120             <span class="keywordflow">return</span> ERROR_SUCCESS == ::RegQueryValueEx(m_hKey, szName, NULL, &amp;dwType, (LPBYTE)&amp;Variable, &amp;dwSize);
00121     }
00122     <span class="keyword">inline</span> <span class="keywordtype">bool</span> SaveLoadItem(LPCTSTR szName, <span class="keywordtype">long</span>&amp; Variable, <span class="keywordtype">bool</span> bSave)
00123     {
00124         <span class="keywordflow">return</span> SaveLoadItem(szName, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>&amp;)Variable, bSave);
00125     }
00126 
00127     <span class="comment">// bool</span>
00128     <span class="keyword">inline</span> <span class="keywordtype">bool</span> SaveLoadItem(LPCTSTR szName, <span class="keywordtype">bool</span>&amp; Variable, <span class="keywordtype">bool</span> bSave)
00129     {
00130         DWORD dwValue = Variable ? 1 : 0;
00131         <span class="keywordtype">bool</span> bResult = SaveLoadItem(szName, dwValue, bSave);
00132         <span class="keywordflow">if</span> (!bSave &amp;&amp; bResult)
00133             Variable = dwValue != 0;
00134         <span class="keywordflow">return</span> bResult;
00135     }
00136 
00137     <span class="comment">// float</span>
00138     <span class="keyword">inline</span> <span class="keywordtype">bool</span> SaveLoadItem(LPCTSTR szName, <span class="keywordtype">float</span>&amp; Variable, <span class="keywordtype">bool</span> bSave)
00139     {
00140         <span class="keywordflow">return</span> SaveLoadItem(szName, (<span class="keywordtype">void</span>*)&amp;Variable, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), bSave);
00141     }
00142 
00143     <span class="comment">// double</span>
00144     <span class="keyword">inline</span> <span class="keywordtype">bool</span> SaveLoadItem(LPCTSTR szName, <span class="keywordtype">double</span>&amp; Variable, <span class="keywordtype">bool</span> bSave)
00145     {
00146         <span class="keywordflow">return</span> SaveLoadItem(szName, (<span class="keywordtype">void</span>*)&amp;Variable, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>), bSave);
00147     }
00148 
00149     <span class="comment">// TCHAR*</span>
00150     <span class="keyword">inline</span> <span class="keywordtype">bool</span> SaveLoadItem(LPCTSTR szName, TCHAR* Variable, ULONG&amp; Size, <span class="keywordtype">bool</span> bSave)
00151     {
00152         DWORD dwType = REG_SZ;
00153         <span class="keywordflow">if</span>(bSave)
00154             <span class="keywordflow">return</span> ERROR_SUCCESS == ::RegSetValueEx(m_hKey, szName, NULL, dwType, (LPBYTE)Variable, Size);
00155         <span class="keywordflow">else</span>
00156         {
00157             DWORD ErrorCode = ::RegQueryValueEx(m_hKey, szName, NULL, &amp;dwType, (LPBYTE)Variable, &amp;Size);
00158             <span class="keywordflow">if</span> (ErrorCode == ERROR_SUCCESS)
00159                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
00160             <span class="keywordflow">if</span> (ErrorCode == ERROR_MORE_DATA)
00161                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00162             Size = 0;
00163             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00164         }
00165     }
00166 
00167     <span class="comment">// void*</span>
00168     <span class="keyword">inline</span> <span class="keywordtype">bool</span> SaveLoadItem(LPCTSTR szName, <span class="keywordtype">void</span>* Variable, ULONG size, <span class="keywordtype">bool</span> bSave)
00169     {
00170         DWORD dwType = REG_BINARY;
00171         DWORD dwSize = (DWORD)size;
00172         <span class="keywordflow">if</span>(bSave)
00173             <span class="keywordflow">return</span> ERROR_SUCCESS == ::RegSetValueEx(m_hKey, szName, NULL, dwType, (LPBYTE)Variable, dwSize);
00174         <span class="keywordflow">else</span>
00175             <span class="keywordflow">return</span> ERROR_SUCCESS == ::RegQueryValueEx(m_hKey, szName, NULL, &amp;dwType, (LPBYTE)Variable, &amp;dwSize);
00176     }
00177 
00178 }; <span class="comment">// class CSettingsStorageRegistry</span>
00179 
00180 
00181 }; <span class="comment">// namespace Mortimer</span>
00182 
00183 <span class="preprocessor">#endif // __MORTIMER_SETTINGSSTORAGEREGISTRY_H__</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri May 28 11:14:20 2004 for SettingsStorage by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
